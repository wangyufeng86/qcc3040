<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Public API: Peer Pairing Service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Public API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li class="current"><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('group__le__peer__pairing__service.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">Peer Pairing Service<div class="ingroups"><a class="el" href="group__services.html">Services</a> &raquo; <a class="el" href="group__peer__service.html">Peer Service</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:peer__pair__le__key_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="peer__pair__le__key_8h.html">peer_pair_le_key.h</a></td></tr>
<tr class="memdesc:peer__pair__le__key_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Header file for the Peer pairing secret key. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga729415e3597a06a484839df83c27f6c3"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga729415e3597a06a484839df83c27f6c3">peer_pair_le_message_t</a> { <a class="el" href="group__le__peer__pairing__service.html#gga729415e3597a06a484839df83c27f6c3a13ec96798e7357637623f782335b9752">PEER_PAIR_LE_PAIR_CFM</a> = PEER_PAIR_LE_MESSAGE_BASE
 }</td></tr>
<tr class="separator:ga729415e3597a06a484839df83c27f6c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga33797ef80dac55a7906d650f4e97c0fd"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga33797ef80dac55a7906d650f4e97c0fd">peer_pair_le_status_t</a> { <b>peer_pair_le_status_success</b>, 
<b>peer_pair_le_status_failed</b>
 }</td></tr>
<tr class="separator:ga33797ef80dac55a7906d650f4e97c0fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga85c263ec511bc8207c9b3cf32b71c18f"><td class="memItemLeft" align="right" valign="top"><a id="ga85c263ec511bc8207c9b3cf32b71c18f"></a>enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga85c263ec511bc8207c9b3cf32b71c18f">peer_pairing_provider_context_t</a> </td></tr>
<tr class="memdesc:ga85c263ec511bc8207c9b3cf32b71c18f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Peer Pairing service UI Provider contexts. <br /></td></tr>
<tr class="separator:ga85c263ec511bc8207c9b3cf32b71c18f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8a999f62c3cade1f9ef36e29f477aff2"><td class="memItemLeft" align="right" valign="top">typedef bool(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga8a999f62c3cade1f9ef36e29f477aff2">ear_function</a>) (bool left)</td></tr>
<tr class="separator:ga8a999f62c3cade1f9ef36e29f477aff2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac5c70d83e259e3345b27f40b2a97d7f0"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#gac5c70d83e259e3345b27f40b2a97d7f0">PeerPairLe_Init</a> (Task init_task, <a class="el" href="group__le__peer__pairing__service.html#ga8a999f62c3cade1f9ef36e29f477aff2">ear_function</a> ear_role)</td></tr>
<tr class="separator:gac5c70d83e259e3345b27f40b2a97d7f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8e57c0d2b3fb5163c0a13dfa98ab06de"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga8e57c0d2b3fb5163c0a13dfa98ab06de">PeerPairLe_FindPeer</a> (Task task)</td></tr>
<tr class="separator:ga8e57c0d2b3fb5163c0a13dfa98ab06de"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2b71d5901fa7522f7a2f1299947b33ae"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga2b71d5901fa7522f7a2f1299947b33ae">PeerPairLe_HandleFoundDeviceScan</a> (const CL_DM_BLE_ADVERTISING_REPORT_IND_T *scan)</td></tr>
<tr class="separator:ga2b71d5901fa7522f7a2f1299947b33ae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7a89457e5593c92692bce925792d700f"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__le__peer__pairing__service.html#ga7a89457e5593c92692bce925792d700f">PeerPairLe_HandleConnectionLibraryMessages</a> (MessageId id, Message message, bool already_handled)</td></tr>
<tr class="separator:ga7a89457e5593c92692bce925792d700f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The LE Peer Pairing Service takes responsibility for using Bluetooth Low Energy (BLE) to pair with another device, record the addresses of both devices, select which address is primary, and update the keys of both devices.</p>
<p>The keys are updated so that in future each device can safely share details of connections to other devices, such as handsets. This is part of Bluetooth Address Management.</p>
<h2>What devices are found ?</h2>
<p>Only compatible devices will be found, compatibility being defined by </p><ul>
<li>support for the LE peer pairing service. The service will attempt to connect with these devices. </li>
<li>having the same 'secret'</li>
</ul>
<p>To reduce the chance of pairing with an unexpected device, two additional criteria are used </p><ul>
<li>The device must be close. This is determined by the received signal strength indication (RSSI), that gives the strength of the advert received. This is controlled by appConfigPeerPairLeMinRssi </li>
<li>Only one device very close. The service can see several devices but will only keep track of the strongest. If the RSSI of the two strongest devices are too similar, both will be rejected. This is controlled by appConfigPeerPairLeMinRssiDelta</li>
</ul>
<h2>Using the service</h2>
<p>Just call <a class="el" href="group__le__peer__pairing__service.html#ga8e57c0d2b3fb5163c0a13dfa98ab06de">PeerPairLe_FindPeer</a> on each device, and the operation is fully autonomous.</p>
<p>The following message is sent to indicate the final status. <a class="el" href="group__le__peer__pairing__service.html#gga729415e3597a06a484839df83c27f6c3a13ec96798e7357637623f782335b9752">PEER_PAIR_LE_PAIR_CFM</a></p>
<p>If the status in the message is #peer_pair_le_status_success then the service has paired successfully. Each device will have recorded the original Bluetooth device address of themselves and their peer. These addresses will be shared in future.</p>
<p>The service also determines which of these addresses is the Primary address that will be used in all communication with the handset, and can . be accessed by appDeviceGetPrimaryBdAddr.</p>
<h2>Basics of operation</h2>
<h3>Find device</h3>
<p>The service works by advertising support for the peer pairing service. At the same time it scans for devices that support the service. Once an advertisement is seen a timeout is started to make sure that the device seen is the closest device. See appConfigPeerPairLeTimeoutPeerSelect.</p>
<p>The timeout is based on a comparison of the Bluetooth device addresses of the devices. In typical usage both devices will recognise each other at about the same time. The different timeouts ensure that one device will connect first.</p>
<h3>Connect</h3>
<p>When advertising the service is always trying to connect to a server.</p>
<p>When an advert has been seen the service stops advertising and attempt to make a connection to a client.</p>
<p>When a connection is established the gatt root key service is started at each end of the link. As a server by one device and as a client by the other.</p>
<h3>Verify device and transfer keys</h3>
<p>The GATT service for root key transfer verifies that the devices are compatible, and transfers the keys between them autonomously.</p>
<p>A link key is also securely generated so that a standard Bluetooth Basic Rate / Enhandced Data Rate (BR/EDR) connection can be made in future without the need to pair separately.</p>
<h3>Disconnect</h3>
<p>The connection between the devices is disconnected once the devices are paired. Although this has the disadvantage of removing a connection that will normally be required immediately, the need to reconnect ensures that connections between the devices can be made reliably after the pairing process.</p>
<h2>State transitions</h2>
<p>The LE peer pairing service uses a state variable to record its current status see #PEER_PAIR_LE_STATE for state names. The use of the state allows the processing of messages and function calls to check what action is required, or error to generate.</p>
<p>The state is set using the function peer_pair_le_set_state(). This function can trigger actions based on the state that has been entered (or exited).</p>
<p>The basics of the state are documented in the diagram below.</p>
<div class="plantumlgraph">
<img src="inline_umlgraph_6.png" />
</div>
 <h2 class="groupheader">Typedef Documentation</h2>
<a id="ga8a999f62c3cade1f9ef36e29f477aff2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8a999f62c3cade1f9ef36e29f477aff2">&#9670;&nbsp;</a></span>ear_function</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef bool(* ear_function) (bool left)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Function type to indicate if device is for left or right ear </p>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="ga729415e3597a06a484839df83c27f6c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga729415e3597a06a484839df83c27f6c3">&#9670;&nbsp;</a></span>peer_pair_le_message_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="group__le__peer__pairing__service.html#ga729415e3597a06a484839df83c27f6c3">peer_pair_le_message_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Messages that may be sent externally by the LE peer pairing service </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="gga729415e3597a06a484839df83c27f6c3a13ec96798e7357637623f782335b9752"></a>PEER_PAIR_LE_PAIR_CFM&#160;</td><td class="fielddoc"><p>Message sent on completion of pairing </p>
</td></tr>
</table>

</div>
</div>
<a id="ga33797ef80dac55a7906d650f4e97c0fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga33797ef80dac55a7906d650f4e97c0fd">&#9670;&nbsp;</a></span>peer_pair_le_status_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="group__le__peer__pairing__service.html#ga33797ef80dac55a7906d650f4e97c0fd">peer_pair_le_status_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Status code included in LE peering pairing service messages </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga8e57c0d2b3fb5163c0a13dfa98ab06de"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8e57c0d2b3fb5163c0a13dfa98ab06de">&#9670;&nbsp;</a></span>PeerPairLe_FindPeer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void PeerPairLe_FindPeer </td>
          <td>(</td>
          <td class="paramtype">Task&#160;</td>
          <td class="paramname"><em>task</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Ask the pairing service to find a peer.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">task</td><td>Task to send message to on completion </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="ga7a89457e5593c92692bce925792d700f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga7a89457e5593c92692bce925792d700f">&#9670;&nbsp;</a></span>PeerPairLe_HandleConnectionLibraryMessages()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool PeerPairLe_HandleConnectionLibraryMessages </td>
          <td>(</td>
          <td class="paramtype">MessageId&#160;</td>
          <td class="paramname"><em>id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Message&#160;</td>
          <td class="paramname"><em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>already_handled</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Handler for connection library messages</p>
<p>This function needs to be called by the task that is registered for connection library messages, as the majority of these are sent to a single registered task.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">id</td><td>The identifier of the connection library message </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">message</td><td>Pointer to the message content. Can be NULL. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">already_handled</td><td>Flag indicating if another task has already dealt with this message</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if the handler has dealt with the message, FALSE otherwise </dd></dl>

</div>
</div>
<a id="ga2b71d5901fa7522f7a2f1299947b33ae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga2b71d5901fa7522f7a2f1299947b33ae">&#9670;&nbsp;</a></span>PeerPairLe_HandleFoundDeviceScan()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void PeerPairLe_HandleFoundDeviceScan </td>
          <td>(</td>
          <td class="paramtype">const CL_DM_BLE_ADVERTISING_REPORT_IND_T *&#160;</td>
          <td class="paramname"><em>scan</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Accepts the LE Advertisements from Scan Manager.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">CL_DM_BLE_ADVERTISING_REPORT_IND_T</td><td>CL Structure for LE Adverts </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="gac5c70d83e259e3345b27f40b2a97d7f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gac5c70d83e259e3345b27f40b2a97d7f0">&#9670;&nbsp;</a></span>PeerPairLe_Init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool PeerPairLe_Init </td>
          <td>(</td>
          <td class="paramtype">Task&#160;</td>
          <td class="paramname"><em>init_task</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__le__peer__pairing__service.html#ga8a999f62c3cade1f9ef36e29f477aff2">ear_function</a>&#160;</td>
          <td class="paramname"><em>ear_role</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p><code>#include &lt;adk/src/services/peer/peer_pair_le/peer_pair_le.h&gt;</code></p>
<p>Initialise the pairing service.</p>
<p>This function MUST be called first before using any other functionality of the pairing service.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">init_task</td><td>Task to send init completion message (if any) to </td></tr>
    <tr><td class="paramname">ear_role</td><td>Function that returns TRUE when asked if the device is Left or Right.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
